---
- name: Provision Moodle web node (RDS/EFS, ansible-pull)
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    # ← moodle_* は group_vars/all.yml を使う。ここでは触らない
    php_packages:
      - nginx
      - git
      - nfs-common
      - php-fpm
      - php-mysql
      - php-xml
      - php-curl
      - php-zip
      - php-gd
      - php-intl
      - php-soap
      - php-xmlrpc
      - php-mbstring

  pre_tasks:
    - name: Ensure base packages (nginx, php, git, nfs)
      ansible.builtin.apt:
        name: "{{ php_packages }}"
        state: present
        update_cache: yes
      become: yes

    - name: Detect PHP minor version (8.x)
      ansible.builtin.command:
        cmd: "php -r 'echo PHP_MAJOR_VERSION.\".\".PHP_MINOR_VERSION;'"
      register: php_ver
      changed_when: false
      failed_when: false

    - name: Set php_minor/php_fpm_service facts
      ansible.builtin.set_fact:
        php_minor: "{{ php_ver.stdout }}"
        php_fpm_service: "php{{ php_ver.stdout }}-fpm"

    - name: Resolve DB host (effective)
      ansible.builtin.set_fact:
        db_host_effective: >-
          {{ (moodle_db_host | default('')) or moodle_db_host_env or moodle_db_host_ssm or moodle_db_host_alt }}

    - name: Show resolved inputs (for troubleshooting only)
      ansible.builtin.debug:
        msg:
          - "aws_region={{ aws_region }}"
          - "php_minor={{ php_minor }}"
          - "moodle_db_host_env={{ moodle_db_host_env }}"
          - "moodle_db_host_ssm={{ moodle_db_host_ssm }}"
          - "moodle_db_host_alt={{ moodle_db_host_alt }}"
          - "db_host_effective={{ db_host_effective }}"

    - name: Ensure moodledata dir exists
      ansible.builtin.file:
        path: "{{ moodle_datadir }}"
        state: directory
        owner: "{{ moodle_web_user }}"
        group: "{{ moodle_web_group }}"
        mode: "0775"
      become: yes

    - name: Ensure EFS line in /etc/fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "{{ moodle_efs_id }}.efs.{{ aws_region }}.amazonaws.com:/  {{ moodle_datadir }}  nfs4  defaults,_netdev  0  0"
        state: present
      when: moodle_efs_id is defined and moodle_efs_id | length > 0
      become: yes

    - name: Mount EFS (idempotent)
      ansible.posix.mount:
        src: "{{ moodle_efs_id }}.efs.{{ aws_region }}.amazonaws.com:/"
        path: "{{ moodle_datadir }}"
        fstype: nfs4
        opts: defaults,_netdev
        state: mounted
      when: moodle_efs_id is defined and moodle_efs_id | length > 0
      become: yes

    - name: Ensure web root exists and owned by web user
      ansible.builtin.file:
        path: "{{ moodle_wwwroot }}"
        state: directory
        owner: "{{ moodle_web_user }}"
        group: "{{ moodle_web_group }}"
        mode: "0755"
      become: yes

    - name: Pre-configure git safe.directory (system level) for webroot
      ansible.builtin.command:
        cmd: "git config --system --add safe.directory {{ moodle_wwwroot }}"
      changed_when: false
      become: yes

    - name: Pre-configure git safe.directory (system level) for default path
      ansible.builtin.command:
        cmd: "git config --system --add safe.directory /var/www/moodle"
      changed_when: false
      become: yes

    - name: Checkout Moodle from GitHub
      ansible.builtin.git:
        repo: "https://github.com/moodle/moodle.git"
        dest: "{{ moodle_wwwroot }}"
        version: "{{ moodle_branch }}"
        force: yes
        update: yes
      become: yes
      become_user: "{{ moodle_web_user }}"

  tasks:
    - name: php.ini for Moodle
      ansible.builtin.template:
        src: "roles/moodle/templates/php-moodle.ini.j2"
        dest: "/etc/php/{{ php_minor }}/fpm/conf.d/99-moodle.ini"
        owner: root
        group: root
        mode: "0644"
      notify: restart services
      become: yes

    - name: Configure PHP timezone for CLI and FPM
      ansible.builtin.lineinfile:
        path: "/etc/php/{{ php_minor }}/{{ item }}/php.ini"
        regexp: '^;?date\.timezone\s*='
        line: "date.timezone = Asia/Tokyo"
        backrefs: yes
      loop: [ "cli", "fpm" ]
      notify: restart services
      become: yes

    - name: Ensure nginx conf for moodle
      ansible.builtin.template:
        src: "roles/moodle/templates/nginx_moodle.conf.j2"
        dest: "/etc/nginx/sites-available/moodle.conf"
        owner: root
        group: root
        mode: "0644"
      notify: restart services
      become: yes

    - name: Enable nginx site (symlink)
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/moodle.conf"
        dest: "/etc/nginx/sites-enabled/moodle.conf"
        state: link
        force: yes
      notify: restart services
      become: yes

    - name: Nginx config test
      ansible.builtin.command: nginx -t
      changed_when: false
      become: yes

    - name: Render Moodle config.php
      ansible.builtin.template:
        src: "roles/moodle/templates/config.php.j2"
        dest: "{{ moodle_wwwroot }}/config.php"
        owner: "{{ moodle_web_user }}"
        group: "{{ moodle_web_group }}"
        mode: "0640"
      vars:
        # ここでテンプレートの moodle_db_host に確定値を注入
        moodle_db_host: "{{ db_host_effective }}"
      become: yes

    - name: Ensure PHP-FPM is enabled and started
      ansible.builtin.service:
        name: "{{ php_fpm_service }}"
        state: started
        enabled: yes
      become: yes

    - name: Ensure nginx is enabled and started
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes
      become: yes

  handlers:
    - name: Restart PHP-FPM
      listen: restart services
      ansible.builtin.service:
        name: "{{ php_fpm_service }}"
        state: restarted
      become: yes

    - name: Reload Nginx
      listen: restart services
      ansible.builtin.service:
        name: nginx
        state: reloaded
      become: yes
